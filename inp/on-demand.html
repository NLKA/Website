<script src='js/jquery.js'></script>
<script>
    $('#topBar').hide();
</script>

<main>
	<div class="ym-wrapper">
        <div class="ym-wbox">
            <div class="box info">
                <h1>Unser neuer Telefondienst</h1>
                <p>Damit wir genau dann erreichbar sind, wenn du uns brauchst, <b>kannst du ab sofort Bescheid sagen, wenn du an einem Tag anrufen möchtest</b>, an dem Nightliner auf Bereitschaft sein können. So können wir mehr potentielle Termine für unser Telefonangebot bereitstellen.</p>

                 <?php
                    include_once('/etc/apache2/db-passwords/nightline.php');

                     // Prepare sql connection
                    $sqlConnetion = new mysqli($DB_HOST, $DB_USER, $DB_PASSWORD, $DB_NAME);

                    // Check if there is a cofirmed service in the future or today
                    $stmt = $sqlConnetion->prepare("SELECT * FROM serviceDay WHERE date >= CURDATE() ORDER BY date ASC;");
                    $stmt->execute();
                    $results = $stmt->get_result();
                    $stmt->close();

                    if ($results->num_rows > 0) {
                    // Display that a service is available
                        $firstRow = $results->fetch_assoc();
                        if ($firstRow['date'] == date('Y-m-d')) {
                            echo "<a id='button' class='ym-button ym-next'>Dienst heute Abend 21-0h anfordern</a>";
                        } else {
                            $date = new DateTime($firstRow['date']);
                            $dateOutputString = $date->format('d.m.');
                            echo "<a id='button' class='ym-button ym-next'>Dienst am ".$dateOutputString." 21-0h anfordern</a>";
                        }
                    } else {
                        echo "Momentan sind keine Dienste geplant.";
                    }
        
                    // Close sql connection
                    $sqlConnetion->close();
                ?>

                <h2>So geht es</h2>
                <p>Klicke oben auf einen Terminvorschlag, an dem du gerne anrufen möchtest.<br/>
                	Du siehst im Anschluss eine Bestätigung: <i>"Vielen Dank, wir haben deine Anforderung erhalten..."</i>. <br/>
                	Dann einfach <b>am angeforderten Tag zwischen 21 und 0 Uhr</b> unter <b>0721-75406646</b> anrufen. Wir freuen uns auf das Gespräch!
				</p>
            </div>
        </div>
   	 </div>

     <!-- Site scripts -->
    <script>
        // Check if success alert should be displayed
        if (getParameterByName('success') == true) {
            setTimeout(function() {
                $('#button').append("   ✔ Angefordert︎");
                alert("Vielen Dank, wir haben deine Anforderung erhalten und werden an dem gewünschten Tag telefonisch erreichbar sein.");

            }, 500);
        }

        function getParameterByName(name) {
            var name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');

            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    
            var results = regex.exec(location.search);
            if (results === null) {
                return ''
            } else {
                return decodeURIComponent(results[1].replace(/\+/g, ' '));
            }
        }

        var secondClick = false;
        $('#button').click( function () {
            if (secondClick) {
                // activate button
                $("#button").attr("href", "../demand.php?origin=onDemandButton");
            } else {
                // on first click: add warning text
                $('#button').before("<br/><p style='background-color: yellow;'>Möchtest du wirklich einen Telefondienst vereinbaren? Unsere Nightliner werden dann im Dienst sein und gerne mit dir sprechen. <b>Wenn du noch nicht sicher bist, ob du anrufen wirst, warte bitte noch einen Moment ab</b> und fordere uns später an. <b>Wenn du sicher bist: Klicke jetzt nochmals auf den Button...</b></p>");
            }

            secondClick = true;
        });
    </script>
    <!-- Site scripts -->
</main>
